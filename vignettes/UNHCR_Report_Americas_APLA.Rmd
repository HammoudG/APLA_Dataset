---
title: "Report Americas UNHCR"
author: "Omar Hammoud Gallego"
date: "07/01/2021"
header-includes:
- \usepackage{setspace}\doublespacing
- \setlength\parindent{24pt}
bookdown::html_document2: default
---

```{r setup, include=TRUE, echo = FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r, Upload Packages}

# Upload Packages for Data analysis and Map
library("dplyr")
library("ggplot2")
theme_set(theme_bw())
library("sf")
library("tmap")
library("rnaturalearth")
library("rnaturalearthdata")
library("tidyr")
library("stringr")  # To do text analysis 
library(rgeos)

library("bookdown")
# For color
library("RColorBrewer")
library("viridis")
library("ggrepel") # might be useful later

# Plot all titles in ggplot2 centered
theme_update(plot.title = element_text(hjust = 0.5))

```

```{r, Upload Data}
# Upload APLA Database
APLA<- APLA::APLA_Database 

# Upload Data for Refugee Numbers only
APLA_Data_1<- APLA::Data_Refugees_UNHCR         # Data APLA  

# Upload Data to Map All Countries Latin America
APLA_Map<- APLA::APLA_Map                      # Data APLA for Mapping 

```

```{r, Calculate Regulatory Complexity, echo = FALSE}

# Transform as Tibble
APLA_T <- as_tibble(APLA)
#APLA_T

# Filter out columns on international agreements
APLA_T1<- APLA_T %>% select(1,2, 35:262)

# Only Questions of Liberalisation and Comments included
APLA_T2<- APLA_T1 %>% select(1,2, ends_with(c("2_1","3_1_1")))

# Select only commentary section to calculate number "Art" to calculate Regulatory Complexity
APLA_T3<- APLA_T2 %>%
  select(1,2, ends_with("3_1_1"))

# Delete of first row
APLA_T3= APLA_T3[-1,]

# Pivot Table for data manipulation
APLA_T_L <- pivot_longer(APLA_T3, cols = colnames(APLA_T3)[3:length(colnames(APLA_T3))],
                        names_to = "Question", values_to = "Comment")

# Transform variable from factor to string
APLA_T_L$Comment<- as.character(APLA_T_L$Comment)

# Value 1 if "Art" present "0" otherwise
APLA_T_L1<- APLA_T_L %>%
  mutate(Included= ifelse(grepl("Art", APLA_T_L$Comment), 1,0))

# Aggregate values of Included per Country, Year, and Question
APLA_T_L2<- APLA_T_L1 %>%
  group_by(Q1,Q2) %>%
  summarise(Frequency= sum(Included))

# Calculate Percentage by looking at number of "Included" per Country/Year as a % of total number of indicators = 57
APLA_T_L3<- APLA_T_L2 %>%
    mutate(Total=57) %>%
    mutate(Regulatory_Complexity= Frequency/Total*100) 

# Round Regulatory Complexity
APLA_T_L3$Regulatory_Complexity<- round(APLA_T_L3$Regulatory_Complexity)

# Rename Country and Year, and Year transformed in numeric
colnames(APLA_T_L3)[1] <- "Country"
colnames(APLA_T_L3)[2] <- "Year"
APLA_T_L3$Year<- as.numeric(as.character(APLA_T_L3$Year))
```

```{r, Calculate Liberalisation Variable, echo = FALSE}

# Run Regulatory Complexity Code First

# Only Questions of Liberalisation and Comments included
APLA_T4<- APLA_T1 %>% select(1,2, ends_with(c("2_1")))

# Delete of first row
APLA_T4= APLA_T4[-1,]

# Pivot Table for data manipulation
APLA_T_L4 <- pivot_longer(APLA_T4, cols = colnames(APLA_T4)[3:length(colnames(APLA_T4))],
                        names_to = "Question", values_to = "Liberalisation_Score")

# Mutate Liberalisation Score into numeric
APLA_T_L4$Liberalisation_Score<- as.numeric(as.character(APLA_T_L4$Liberalisation_Score, na.rm= TRUE))
APLA_T_L4$Question<- as.factor(APLA_T_L4$Question)

APLA_T_L4[complete.cases(APLA_T_L4),]

# Aggregate values of Included per Country, Year, and Question
APLA_T_L5<- APLA_T_L4 %>%
  na.omit() %>%
  group_by(Q1,Q2) %>%
  summarise(Liberal_Policies= sum(Liberalisation_Score == 0), Restrictive_Policies= sum(Liberalisation_Score == 1)) %>%
  mutate(Sum_Both = Liberal_Policies + Restrictive_Policies) %>%
  mutate(Liberalisation= Liberal_Policies/ Sum_Both)
  
# Round Liberalisation
APLA_T_L5$Liberalisation<- round(APLA_T_L5$Liberalisation, digits = 2)

# Take only values where Total_Both => 9
APLA_T_L6<- APLA_T_L5[APLA_T_L5$Sum_Both >= 9, ]

# Rename Country and Year, and Year transformed in numeric
colnames(APLA_T_L6)[1] <- "Country"
colnames(APLA_T_L6)[2] <- "Year"
APLA_T_L6$Year<- as.numeric(as.character(APLA_T_L6$Year))


```

# Introduction

To provide some context on the legal framework on asylum policies in Latin America, here we present the results of a recent analysis of the asylum policies of 19 Latin American countries over the last 30 years. Following the 1984 Cartagena Refugee Declaration, the UNHCR together with governments from the region reconvened in 1994 in San Jose, Costa Rica, in 2004 in Mexico, and 2014 in Brazil to set out a series of declarations and action plans that served as a basis for the development of a regional framework for the protection of refugees.  

The results of these efforts are visible in the Figure below. Over the last three decades countries across Latin America have either adopted for the first time, or reformed, their asylum legislation. This has put the region at the forefront in the adoption of mostly progressive legal frameworks for the protection of asylum seekers and refugees. 

```{r Plots of Development of Policy Over-Time Across Countries for Paper 1. Regulatory Complexity}
ggplot(APLA_T_L3, aes(Year, Regulatory_Complexity, col= Country)) +
  geom_line()+
  facet_wrap(.~ Country, ncol= 5)+
  theme(legend.position = "none")+  # to remove legend
  ggtitle("Regulatory Complexity in Asylum Policies across Latin America, 1990-2020") +
  ylab("Regulatory Complexity")
 
```

```{r, Prepare data for plotting policy measures}
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)

# Rename column where names is "name", so that I can merge with my other dataset
colnames(APLA)[1] <- "Name"
colnames(APLA)[2] <- "Year"
colnames(world)[4] <- "Name"

# Create Database with Selected Years for Plotting
Filtered_APLA<- APLA %>%                                       
  filter(Year %in% c("1990", "2000", "2010", "2020"))

# To Remove level from dropped rows!! 
Filtered_APLA<- droplevels(Filtered_APLA, drop=TRUE)

# VERY IMPORTANT TO MERGE MAP AND DATA 
Policy_Maps<- merge(Filtered_APLA, world, by="Name")

# to transform IMPALA from data frame into sf and data.frame
st_geometry(Policy_Maps) <- Policy_Maps$geometry

# to add colour to map
library(RColorBrewer)
#display.brewer.all()
```

Within this context, some specific policy measures adopted across the region are noteworthy. 
First of all, most countries across the region have included into their legislation the so-called 'Cartagena Refugee Definition', which extends the 1951 Refugee Definition from the Geneva Convention, to include 

> 'persons who have fled their country because their lives, security or freedom have been threatened by generalized violence, foreign aggression, internal conflicts, massive violation of human rights or other circumstances which have seriously disturbed public order'

```{r, cartagena Refugee Definition}
# Cartagena Refugee Definition LA7
tm_shape(Policy_Maps) + tm_borders("black", lwd= .5) + tm_polygons("LA7.1_1", title="Cartagena Refugee Definition", palette= c("#ef8a62","#f7f7f7", "#67a9cf"), style="fixed", breaks=c(0.0, 1.0), labels=c("No or Underdeveloped Legislation","Not Incorporated","Cartagena Incorporated")) + tm_facets(by = "Year")
```



HOWEVER 

While the scale and determinants of the on-going Venezuelan displacement crisis have been widely acknowledged to resemble the gravity of a refugee crisis, in few cases countries in the regions have adopted their legal frameworks for the reception of Venezuelan nationals.  
